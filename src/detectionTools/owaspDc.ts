import { execSync, spawn } from 'child_process';
import { DetectionToolFunction } from '../interfaces/types';
import { getDetectionToolBase, handleErrorsAndPromisify } from './util';

const TOOL_NAME = 'Dependency-Check';

async function getDetectionTool() {
    const versionOutput = execSync('dependency-check.sh -v').toString().trim();
    const versionArray = versionOutput.split(' ');
    const version = versionArray[versionArray.length - 1];
    return getDetectionToolBase(TOOL_NAME, version);
}

const runScan: DetectionToolFunction = (project, projectPath, resultsPath, packageJsonDirs, tool) => {
    const cmd = `dependency-check.sh --prettyPrint --project ${project.name} -o ${resultsPath} -f JSON -s .`;
    const child = spawn(cmd, { cwd: projectPath, shell: true });
    return handleErrorsAndPromisify(child, project, tool);
}

export default {
    getDetectionTool,
    runScan,
};
