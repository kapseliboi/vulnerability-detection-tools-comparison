import { spawn } from 'child_process';
import Path from 'path';
import { DetectionToolFunction } from '../interfaces/types';
import { handleErrorsAndPromisify } from './util';

const TOOL_NAME = 'snyk';

const func: DetectionToolFunction = (project, projectPath, resultsPath, packageJsonDirs) => {
    const snykDepsReportPath = Path.join(resultsPath, 'snykDeps.json');
    const snykVulnReportPath = Path.join(resultsPath, 'snykVuln.json');
    const cmd = `snyk test --all-projects --detection-depth=1000 --dev --print-deps --json --json-file-output=${snykVulnReportPath} | sed '/^}$/q' > ${snykDepsReportPath}`;
    const child = spawn(cmd, { cwd: projectPath, shell: true });
    return handleErrorsAndPromisify(child, project, TOOL_NAME);
}

export default func;
