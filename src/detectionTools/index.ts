import owaspDc from './owaspDc';
import npmAudit from './npmAudit';
import owaspDt from './owaspDt';
import snyk from './snyk';
import whiteSource from './whitesource';
import dependabot from './dependabot';
import config from '../config';
import fs from 'fs';
import path from 'path';
import { Project } from '../entities/project';
import { getManager } from 'typeorm';
import { checkPromisesForErrors, saveToDbWithErrorHandling } from '../util';

const tools = [
    owaspDc,
    owaspDt,
    npmAudit,
    snyk,
    whiteSource,
    dependabot,
];

export async function runDetectionWithAllTools(project: Project, packageJsonDirs: string[]) {
    const projectPath = config.TMP_DIR_PATH;
    const resultsPath = config.RESULTS_PATH;
    const projectResultsPath = ensureResultsFolderIsReady(project, resultsPath);
    const projectAnalysisPromises: Promise<void>[] = [];
    for (const tool of tools) {
        projectAnalysisPromises.push(tool(project, projectPath, projectResultsPath, packageJsonDirs));
    }

    const entityManager = getManager();

    try {
        const promises = await Promise.allSettled(projectAnalysisPromises);
        checkPromisesForErrors(promises);
        project.lastSuccessfulAnalysis = new Date();
        await saveToDbWithErrorHandling(entityManager, Project, project, `Error when saving successful analysis to database for project ${project.name}`);
    } catch (err) {
        console.log(`Project analysis failed with error: ${err && err.message}`);
    }
}

function ensureResultsFolderIsReady(project: Project, resultsPath: string) {
    if (!fs.existsSync(resultsPath)) {
        fs.mkdirSync(resultsPath);
    }

    const projectResultsPath = path.join(resultsPath, project.name, project.commitHash);
    if (!fs.existsSync(projectResultsPath)) {
        fs.mkdirSync(projectResultsPath, { recursive: true });
    }
    return projectResultsPath;
}
