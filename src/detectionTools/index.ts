import { SelectedProjectWithHash } from '../interfaces/types';
import owaspDc from './owaspDc';
import npmAudit from './npmAudit';
import owaspDt from './owaspDt';
import { spawn } from 'child_process';
import fs from 'fs';
import Path from 'path';

const tools = [
    owaspDc,
    owaspDt,
    npmAudit,
];

export function runDetectionWithAllTools(project: SelectedProjectWithHash, projectPath: string, resultsPath: string, packageJsonDirs: string[]) {
    const projectResultsPath = ensureResultsFolderIsReady(project, resultsPath);
    for (const tool of tools) {
        const cmd = tool(project, projectPath, projectResultsPath, packageJsonDirs);
        const child = spawn(cmd, { cwd: projectPath, shell: true });
        child.stdout.pipe(process.stdout);
        child.stderr.pipe(process.stderr);
        child.on('exit', (code, signal) => {
            if (code === 0 ) {
                console.log(`Command "${cmd}" executed successfully`);
            } else {
                console.log(`Command "${cmd}" exited with error code ${code} and signal ${signal}`);
            }
        });

        child.on('error', (err) => {
            console.log(`Command "${cmd}" exited with error: ${err.message}`);
        });
    }
}

function ensureResultsFolderIsReady(project: SelectedProjectWithHash, resultsPath: string) {
    if (!fs.existsSync(resultsPath)) {
        fs.mkdirSync(resultsPath);
    }

    const projectResultsPath = Path.join(resultsPath, project.name, project.commitHash);
    if (!fs.existsSync(projectResultsPath)) {
        fs.mkdirSync(projectResultsPath, { recursive: true });
    }
    return projectResultsPath;
}
