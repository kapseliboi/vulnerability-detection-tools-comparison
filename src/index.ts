import yargs from 'yargs';
import { hideBin } from 'yargs/helpers';
import { createConnection, getConnectionOptions } from 'typeorm';
import { analyze } from './analyze';
import config from './config';

import 'reflect-metadata';
import { CliAnalyzeOptions, CliSelectOptions } from './interfaces/types';
import { select } from './select';

async function initDbConnection() {
    const connectionOptions = await getConnectionOptions();
    Object.assign(connectionOptions, {
        entities: config.usingTsNode ? ['src/entities/**/*.ts'] : ['build/entities/**/*.js'],
        migrations: config.usingTsNode ? ['src/migrations/**/*.ts'] : ['build/migrations/**/*.js'],
    });
    await createConnection(connectionOptions);
}

async function main() {
    await initDbConnection();
    const _argv = yargs(hideBin(process.argv))
        .command<CliAnalyzeOptions>(
            'analyze',
            'Analyze projects from database or from an input JSON file',
            (analyzeYargs) => {
                analyzeYargs.positional('inputFile', { type: 'string', describe: 'path to project input file' });
                analyzeYargs.options('skip', { type: 'number', describe: 'Skip x amount of projects' });
                analyzeYargs.options('take', { type: 'number', describe: 'Only analyze x amount of projects'});
            },
            async (argv) => {
                await analyze({
                    skip: argv.skip,
                    take: argv.take,
                    inputFile: argv.inputFile,
                });
                process.exit(0);
            })
        .command<CliSelectOptions>(
            'select [inputFile]',
            'Select projects from a JSON file',
            (selectYargs) => {
                selectYargs.positional('inputFile', { type: 'string', describe: 'path to project input file' })
                    .demandOption('inputFile');
                selectYargs.options('minDepCount', { type: 'number', describe: 'Minimum amount of dependencies the project has to have' });
            },
            async (argv) => {
                await select({
                    inputFile: argv.inputFile,
                    minDepCount: argv.minDepCount,
                });
                process.exit(0);
            }
        )
        .help('h')
        .alias('h', 'help')
        .argv;
}

main();