import fs from 'fs';
import { runDetectionWithAllTools } from '../detectionTools';
import { FindManyOptions, getManager } from 'typeorm';
import { Project } from '../entities/project';
import { confirmQuestion, downLoadProjectAndInstallDependencies, question } from '../util';
import { ProjectError } from '../entities/projectError';

export interface Options {
    inputFile?: string;
    skip?: number;
    take?: number;
    noDownloadOrInstall: boolean;
    project?: string;
    useResultFiles: boolean;
}


export async function execute(options: Options) {
    const entityManager = getManager();
    console.log(`Running execute with options:\n${JSON.stringify(options, null, 2)}`);
    const verification = await confirmQuestion('Are the options correct?');
    if (!verification) {
        return;
    }
    let projects: Project[] = [];
    if (options.inputFile) {
        projects = await entityManager.save(Project, JSON.parse(fs.readFileSync(options.inputFile, 'utf-8')));
    } else {
        const findOptions: FindManyOptions<Project> = {
            order: {
                createdAt: 'ASC',
            },
        };
        if (options.project !== undefined && options.project.length) {
            findOptions.where = [{ name: options.project }]
            findOptions.take = 1;
        } else {
            if (options.skip) {
                findOptions.skip = options.skip;
            }
            if (options.take) {
                findOptions.take = options.take;
            }
        }
        projects = await entityManager.find(Project, findOptions);
        console.log(`Analysing ${projects.length} projects`);
    }

    for (const project of projects) {
        const lockfileDirs = await downLoadProjectAndInstallDependencies(project, false, true, options.noDownloadOrInstall, true);
        if (lockfileDirs.length === 0) {
            console.log(`Project ${project.name} doesn't contain a lockfile. Skipping analysis and creating an error`);
            const projErr = entityManager.create(ProjectError, {
                project,
                phase: 'LOCKFILE DISCOVERY',
                message: 'No lockfiles found. GitHub GraphQL API most likely made a mistake',
            });
            await entityManager.save(ProjectError, projErr);
            continue;
        }
        console.log(`\n\nSTARTING ANALYSIS FOR PROJECT ${project.name}\n\n`);
        await runDetectionWithAllTools(project, lockfileDirs, options.useResultFiles);
    }
}
