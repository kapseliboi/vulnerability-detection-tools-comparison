import axios from "axios";
import { getManager } from "typeorm";
import { Project } from "../entities/project";
import { getGitHubRestClient } from "../util";

export async function deleteForks() {
    const entityManager = getManager();
    const projects = await entityManager.find(Project);
    const client = getGitHubRestClient();
    for (const project of projects) {
        console.log(`Deleting fork of project ${project.name}`);
        try {
            await client.delete(`/repos/${project.forkedName}`);
        } catch(err) {
            if (axios.isAxiosError(err) && err.response?.status === 404) {
                console.log(`Couldn't find fork ${project.forkedName}`);
            } else {
                console.log(`Removing fork ${project.forkedName} failed`);
            }
        }
    }
    console.log(`Deleted all forks`);
}