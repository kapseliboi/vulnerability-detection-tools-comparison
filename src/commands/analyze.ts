import fs from 'fs';
import { runDetectionWithAllTools } from '../detectionTools';
import { FindManyOptions, getManager } from 'typeorm';
import { Project } from '../entities/project';
import { downLoadProjectAndInstallDependencies } from '../util';
import { ProjectError } from '../entities/projectError';

export interface Options {
    inputFile?: string;
    skip?: number;
    take?: number;
    noDownloadOrInstall: boolean;
}


export async function analyze(options: Options) {
    const entityManager = getManager();
    let projects: Project[] = [];
    if (options.inputFile) {
        projects = await entityManager.save(Project, JSON.parse(fs.readFileSync(options.inputFile, 'utf-8')));
    } else {
        const findOptions: FindManyOptions<Project> | undefined = {
            order: {
                createdAt: 'ASC',
            },
        };
        if (options.skip) {
            findOptions.skip = options.skip;
        }
        if (options.take) {
            findOptions.take = options.take;
        }
        projects = await entityManager.find(Project, findOptions);
        console.log(`Analysing ${projects.length} projects`);
    }

    for (const project of projects) {
        const lockfileDirs = await downLoadProjectAndInstallDependencies(project, false, true, options.noDownloadOrInstall, true);
        if (lockfileDirs.length === 0) {
            console.log(`Project ${project.name} doesn't contain a lockfile. Skipping analysis and creating an error`);
            const projErr = entityManager.create(ProjectError, {
                project,
                phase: 'LOCKFILE DISCOVERY',
                message: 'No lockfiles found. GitHub GraphQL API most likely made a mistake',
            });
            await entityManager.save(ProjectError, projErr);
            continue;
        }
        console.log('Starting to analyze projects for vulnerabilities');
        await runDetectionWithAllTools(project, lockfileDirs);
    }
}
